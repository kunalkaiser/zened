<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZenEd ‚Äî Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{--teal:#0ea87a;--teal-dark:#0b8f68;--teal-light:#e6f7f2;--black:#0d0d0d;--white:#fff;--cream:#f8fafc;--gray:#64748b;--gray-light:#f1f5f9;--border:#e2e8f0;--red:#ef4444;--yellow:#f59e0b;--green:#10b981;}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--cream);color:var(--black);min-height:100vh;-webkit-font-smoothing:antialiased;}
#loader{position:fixed;inset:0;background:var(--black);display:flex;align-items:center;justify-content:center;z-index:9999;transition:opacity 0.4s;}
#loader.hide{opacity:0;pointer-events:none;}
.loader-inner{display:flex;align-items:center;gap:12px;color:white;font-size:24px;font-weight:800;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}
.loader-dot{width:8px;height:8px;background:var(--teal);border-radius:50%;animation:pulse 1s infinite;}
#toast{position:fixed;bottom:80px;right:20px;padding:12px 20px;border-radius:12px;font-size:14px;font-weight:600;z-index:9999;transform:translateY(20px);opacity:0;transition:all 0.3s;pointer-events:none;max-width:300px;}
#toast.show{transform:translateY(0);opacity:1;}
#toast.success{background:#15803d;color:white;}
#toast.error{background:var(--red);color:white;}
#toast.info{background:var(--black);color:white;}
@keyframes slideUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
/* AUTH */
#authScreen{min-height:100vh;display:none;align-items:center;justify-content:center;background:linear-gradient(135deg,#0a0a0a,#0f1f3d);}
.auth-card{background:white;border-radius:24px;padding:44px 40px;width:420px;max-width:95vw;box-shadow:0 24px 64px rgba(0,0,0,0.35);animation:slideUp 0.4s ease;}
.auth-logo{display:flex;align-items:center;gap:10px;margin-bottom:6px;}
.auth-logo-ico{width:42px;height:42px;background:linear-gradient(135deg,#0ea87a,#076b4f);border-radius:12px;display:flex;align-items:center;justify-content:center;box-shadow:0 3px 12px rgba(14,168,122,0.4);}
.auth-logo-word{font-size:28px;font-weight:800;letter-spacing:-1px;}
.auth-logo-word em{color:var(--teal);font-style:normal;}
.auth-sub{font-size:13px;color:var(--gray);margin-bottom:28px;}
.tab-row{display:flex;background:var(--gray-light);border-radius:10px;padding:3px;margin-bottom:24px;}
.tab-btn{flex:1;padding:9px;border:none;background:none;border-radius:8px;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;font-weight:600;color:var(--gray);transition:all 0.2s;}
.tab-btn.on{background:white;color:var(--black);box-shadow:0 1px 4px rgba(0,0,0,0.12);}
.fgroup{margin-bottom:14px;}
.flbl{display:block;font-size:13px;font-weight:600;margin-bottom:5px;}
.finp{width:100%;padding:11px 14px;border:1.5px solid var(--border);border-radius:10px;font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;color:var(--black);outline:none;transition:border-color 0.2s;background:white;}
.finp:focus{border-color:var(--teal);}
select.finp{cursor:pointer;}
.role-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;}
.role-btn{padding:12px 6px;border:1.5px solid var(--border);border-radius:10px;cursor:pointer;text-align:center;font-size:12px;font-weight:600;color:var(--gray);background:white;transition:all 0.2s;font-family:'Plus Jakarta Sans',sans-serif;}
.role-btn:hover,.role-btn.on{border-color:var(--teal);background:var(--teal-light);color:var(--teal);}
.role-emoji{font-size:22px;display:block;margin-bottom:4px;}
.btn-main{width:100%;padding:13px;border:none;border-radius:10px;background:var(--black);color:white;font-family:'Plus Jakarta Sans',sans-serif;font-size:15px;font-weight:700;cursor:pointer;transition:all 0.2s;margin-top:6px;}
.btn-main:hover{background:#1e1e1e;}
.btn-main:disabled{opacity:0.5;cursor:not-allowed;}
.auth-msg{padding:10px 13px;border-radius:8px;font-size:13px;margin-bottom:14px;display:none;}
.auth-msg.err{background:#fff1f2;color:var(--red);border:1px solid #fecdd3;}
.auth-msg.ok{background:#f0fdf4;color:#15803d;border:1px solid #bbf7d0;}
/* APP */
#app{display:none;min-height:100vh;}
.topbar{height:58px;background:white;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 24px;position:sticky;top:0;z-index:100;}
.top-logo{display:flex;align-items:center;gap:9px;text-decoration:none;color:var(--black);}
.top-logo-ico{width:30px;height:30px;background:linear-gradient(135deg,#0ea87a,#076b4f);border-radius:8px;display:flex;align-items:center;justify-content:center;}
.top-logo-word{font-weight:800;font-size:18px;letter-spacing:-0.4px;}
.top-logo-word em{color:var(--teal);font-style:normal;}
.topbar-right{display:flex;align-items:center;gap:10px;}
.rbadge{font-size:11px;font-weight:700;padding:3px 11px;border-radius:20px;text-transform:capitalize;}
.rbadge.student{background:#eff6ff;color:#2563eb;}
.rbadge.teacher{background:#f0fdf4;color:#15803d;}
.rbadge.parent{background:#fdf4ff;color:#9333ea;}
.top-name{font-size:13px;color:var(--gray);}
.top-name b{color:var(--black);}
.btn-out{padding:7px 14px;background:none;border:1.5px solid var(--border);border-radius:8px;font-size:13px;font-weight:500;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;transition:all 0.2s;}
.btn-out:hover{background:var(--gray-light);}
.app-body{display:flex;min-height:calc(100vh - 58px);}
.sidebar{width:220px;background:white;border-right:1px solid var(--border);padding:16px 10px;flex-shrink:0;position:sticky;top:58px;height:calc(100vh - 58px);overflow-y:auto;}
.nav-lbl{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--gray);padding:0 8px;margin-bottom:8px;}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 11px;border-radius:10px;cursor:pointer;font-size:13px;font-weight:500;color:var(--gray);transition:all 0.15s;border:none;background:none;width:100%;text-align:left;font-family:'Plus Jakarta Sans',sans-serif;}
.nav-item:hover{background:var(--gray-light);color:var(--black);}
.nav-item.on{background:var(--teal-light);color:var(--teal);font-weight:700;}
.nav-sep{border:none;border-top:1px solid var(--border);margin:12px 0;}
.content{flex:1;padding:28px 32px;max-width:960px;}
/* PAGE COMPONENTS */
.page{animation:slideUp 0.2s ease;}
.page-title{font-size:22px;font-weight:800;letter-spacing:-0.5px;margin-bottom:4px;}
.page-sub{font-size:13px;color:var(--gray);margin-bottom:24px;line-height:1.6;}
.card{background:white;border-radius:16px;padding:22px;border:1px solid var(--border);box-shadow:0 1px 4px rgba(0,0,0,0.05);margin-bottom:16px;}
.card-head{font-size:15px;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:7px;}
.section{background:white;border-radius:16px;padding:22px;border:1px solid var(--border);box-shadow:0 1px 4px rgba(0,0,0,0.05);margin-bottom:16px;}
.sec-head{font-size:15px;font-weight:700;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;}
.g3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:16px;}
.g2{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-bottom:16px;}
.r-circle{width:84px;height:84px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 10px;font-size:20px;font-weight:800;}
.r-circle.green{background:rgba(16,185,129,.1);color:#059669;}
.r-circle.yellow{background:rgba(245,158,11,.1);color:#d97706;}
.r-circle.red{background:rgba(239,68,68,.1);color:#dc2626;}
.r-circle.empty{background:var(--gray-light);color:var(--gray);font-size:28px;}
.r-label{font-size:13px;font-weight:700;text-align:center;margin-bottom:2px;}
.r-label.green{color:#059669}.r-label.yellow{color:#d97706}.r-label.red{color:#dc2626}
.r-sub{font-size:11px;color:var(--gray);text-align:center;}
.frow{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.btn-black{padding:11px 22px;background:var(--black);color:white;border:none;border-radius:9px;font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:all 0.2s;}
.btn-black:hover{background:#1e1e1e;}
.btn-black:disabled{opacity:0.45;cursor:not-allowed;}
.btn-teal{padding:11px 22px;background:var(--teal);color:white;border:none;border-radius:9px;font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:all 0.2s;}
.btn-teal:hover{background:var(--teal-dark);}
.save-ok{background:#f0fdf4;color:#15803d;border:1px solid #bbf7d0;border-radius:8px;padding:9px 13px;font-size:13px;margin-top:10px;display:none;}
.irow{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:12px;}
.irow .finp{flex:1;min-width:140px;}
table{width:100%;border-collapse:collapse;font-size:13px;}
th{text-align:left;padding:9px 12px;background:var(--gray-light);font-weight:700;font-size:11px;color:var(--gray);text-transform:uppercase;letter-spacing:0.5px;}
td{padding:11px 12px;border-bottom:1px solid var(--border);}
tr:last-child td{border-bottom:none;}
.badge{display:inline-block;padding:3px 9px;border-radius:20px;font-weight:700;font-size:11px;}
.badge.g{background:rgba(16,185,129,.1);color:#059669;}
.badge.y{background:rgba(245,158,11,.1);color:#d97706;}
.badge.r{background:rgba(239,68,68,.1);color:#dc2626;}
.rec{display:flex;gap:12px;padding:12px 0;border-bottom:1px solid var(--border);}
.rec:last-child{border-bottom:none;}
.rec-dot{width:9px;height:9px;border-radius:50%;margin-top:4px;flex-shrink:0;}
.rec-dot.high{background:var(--red)}.rec-dot.mid{background:var(--yellow)}.rec-dot.low{background:var(--green)}
.rec-topic{font-size:14px;font-weight:700;margin-bottom:2px;}
.rec-detail{font-size:12px;color:var(--gray);margin-bottom:4px;}
.rec-link{font-size:12px;color:var(--teal);text-decoration:none;font-weight:600;}
.rec-link:hover{text-decoration:underline;}
.class-card{background:white;border:1px solid var(--border);border-radius:12px;padding:16px 18px;margin-bottom:10px;display:flex;align-items:center;justify-content:space-between;}
.class-name{font-size:14px;font-weight:700;margin-bottom:2px;}
.class-meta{font-size:12px;color:var(--gray);}
.code-pill{background:var(--black);color:white;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:700;letter-spacing:1.5px;}
.tgrid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;}
.titem{display:flex;align-items:center;gap:12px;padding:14px 16px;border:1.5px solid var(--border);border-radius:12px;text-decoration:none;color:var(--black);transition:all 0.2s;}
.titem:hover{border-color:var(--teal);background:var(--teal-light);transform:translateY(-1px);}
.titem-ico{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.titem-name{font-size:13px;font-weight:700;margin-bottom:2px;}
.titem-desc{font-size:11px;color:var(--gray);}
.ftag{margin-left:auto;font-size:10px;font-weight:700;padding:3px 8px;border-radius:10px;flex-shrink:0;}
.ftag.free{background:#e6f7f2;color:#0b8f68;}
.ftag.paid{background:#fef3c7;color:#d97706;}
.empty-box{text-align:center;padding:48px 20px;color:var(--gray);}
.empty-box h3{font-size:17px;font-weight:700;color:var(--black);margin-bottom:8px;}
.empty-box p{font-size:13px;line-height:1.6;}
/* MOBILE BOTTOM NAV */
.mob-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:white;border-top:1px solid var(--border);z-index:200;padding:6px 0 env(safe-area-inset-bottom,6px);}
.mob-inner{display:flex;justify-content:space-around;}
.mb-btn{display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px 8px;border:none;background:none;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;font-size:10px;font-weight:600;color:var(--gray);border-radius:8px;transition:color 0.15s;min-width:52px;}
.mb-btn.on{color:var(--teal);}
.mb-ico{font-size:20px;line-height:1;}
@media(max-width:768px){
  .sidebar{display:none;}
  .mob-nav{display:block;}
  .content{padding:16px 16px 80px;}
  .g3,.g2{grid-template-columns:1fr;}
  .frow{grid-template-columns:1fr;}
  .tgrid{grid-template-columns:1fr;}
  .top-name{display:none;}
}
</style>
</head>
<body>

<div id="loader">
  <div class="loader-inner">
    <div style="width:36px;height:36px;background:linear-gradient(135deg,#0ea87a,#076b4f);border-radius:10px;display:flex;align-items:center;justify-content:center">
      <svg viewBox="0 0 24 24" fill="none" width="20" height="20"><path d="M12 3L4 8V16L12 21L20 16V8L12 3Z" stroke="white" stroke-width="1.5" stroke-linejoin="round"/><path d="M8 11L12 15L16 11" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 7V15" stroke="white" stroke-width="1.5" stroke-linecap="round"/></svg>
    </div>
    ZenEd <div class="loader-dot"></div>
  </div>
</div>

<div id="toast"></div>

<!-- AUTH -->
<div id="authScreen">
  <div class="auth-card">
    <div class="auth-logo">
      <div class="auth-logo-ico"><svg viewBox="0 0 24 24" fill="none" width="22" height="22"><path d="M12 3L4 8V16L12 21L20 16V8L12 3Z" stroke="white" stroke-width="1.5" stroke-linejoin="round"/><path d="M8 11L12 15L16 11" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 7V15" stroke="white" stroke-width="1.5" stroke-linecap="round"/></svg></div>
      <span class="auth-logo-word">Zen<em>Ed</em></span>
    </div>
    <p class="auth-sub">Know where you stand. Know what to study.</p>
    <div class="tab-row">
      <button class="tab-btn on" id="tabLogin" onclick="authTab('login')">Sign In</button>
      <button class="tab-btn" id="tabSignup" onclick="authTab('signup')">Create Account</button>
    </div>
    <div id="authMsg" class="auth-msg"></div>
    <button onclick="doGoogleSignIn()" style="width:100%;padding:12px;margin-bottom:14px;border:1.5px solid #e8e8e5;border-radius:10px;background:#fff;font-family:inherit;font-size:14px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;transition:border-color .15s;" onmouseover="this.style.borderColor='#0d0d0d'" onmouseout="this.style.borderColor='#e8e8e5'">
      <svg width="18" height="18" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Continue with Google
    </button>
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;"><div style="flex:1;height:1px;background:#e8e8e5"></div><span style="font-size:11px;color:#9ca3af;font-weight:600">OR</span><div style="flex:1;height:1px;background:#e8e8e5"></div></div>
    <div id="loginForm">
      <div class="fgroup"><label class="flbl">Email</label><input class="finp" type="email" id="liEmail" placeholder="your@email.com" onkeypress="if(event.key==='Enter')doLogin()"></div>
      <div class="fgroup"><label class="flbl">Password</label><input class="finp" type="password" id="liPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeypress="if(event.key==='Enter')doLogin()"></div>
      <button class="btn-main" id="liBtn" onclick="doLogin()">Sign In ‚Üí</button>
    </div>
    <div id="signupForm" style="display:none">
      <button onclick="doGoogleSignIn()" style="width:100%;padding:12px;margin-bottom:14px;border:1.5px solid #e8e8e5;border-radius:10px;background:#fff;font-family:inherit;font-size:14px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;" onmouseover="this.style.borderColor='#0d0d0d'" onmouseout="this.style.borderColor='#e8e8e5'">
        <svg width="18" height="18" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
        Sign up with Google
      </button>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;"><div style="flex:1;height:1px;background:#e8e8e5"></div><span style="font-size:11px;color:#9ca3af;font-weight:600">OR</span><div style="flex:1;height:1px;background:#e8e8e5"></div></div>
      <div class="fgroup"><label class="flbl">Full Name</label><input class="finp" type="text" id="suName" placeholder="Jane Smith"></div>
      <div class="fgroup"><label class="flbl">Email</label><input class="finp" type="email" id="suEmail" placeholder="your@email.com"></div>
      <div class="fgroup"><label class="flbl">Password</label><input class="finp" type="password" id="suPass" placeholder="Min 6 characters"></div>
      <div class="fgroup"><label class="flbl">I am a...</label>
        <div class="role-row">
          <button class="role-btn" id="r-student" onclick="pickRole('student')"><span class="role-emoji">üéí</span>Student</button>
          <button class="role-btn" id="r-teacher" onclick="pickRole('teacher')"><span class="role-emoji">üìö</span>Teacher</button>
          <button class="role-btn" id="r-parent" onclick="pickRole('parent')"><span class="role-emoji">üë®‚Äçüë©‚Äçüëß</span>Parent</button>
        </div>
      </div>
      <div class="fgroup" id="gradeRow" style="display:none"><label class="flbl">Grade Level</label>
        <select class="finp" id="suGrade">
          <option value="">Select grade...</option>
          <option value="8">8th Grade</option><option value="9">9th Grade</option>
          <option value="10">10th Grade</option><option value="11">11th Grade</option><option value="12">12th Grade</option>
        </select>
      </div>
      <button class="btn-main" id="suBtn" onclick="doSignup()">Create Account ‚Üí</button>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <div class="topbar">
    <a href="index.html" class="top-logo">
      <div class="top-logo-ico"><svg viewBox="0 0 24 24" fill="none" width="16" height="16"><path d="M12 3L4 8V16L12 21L20 16V8L12 3Z" stroke="white" stroke-width="1.5" stroke-linejoin="round"/><path d="M8 11L12 15L16 11" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 7V15" stroke="white" stroke-width="1.5" stroke-linecap="round"/></svg></div>
      <span class="top-logo-word">Zen<em>Ed</em></span>
    </a>
    <div class="topbar-right">
      <span class="rbadge student" id="topRole">student</span>
      <span class="top-name">Welcome, <b id="topName">User</b></span>
      <button class="btn-out" onclick="doLogout()">Log out</button>
    </div>
  </div>
  <div class="app-body">
    <div class="sidebar" id="sidebar"></div>
    <div class="content" id="content"></div>
  </div>
  <div class="mob-nav" id="mobNav" style="display:none">
    <div class="mob-inner" id="mobNavInner"></div>
  </div>
</div>

<script>
const db = supabase.createClient(
  'https://spkqmhrogykcbrvujgub.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwa3FtaHJvZ3lrY2JydnVqZ3ViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3OTU0OTEsImV4cCI6MjA4NzM3MTQ5MX0.00fS4NTvcC4f-mD8gRSqD1huWIdHo8Xe6UMZn8UJeb0'
);
let USER=null, PROFILE=null, ROLE='';

// ‚îÄ‚îÄ NY‚ÜíM+ SCALE ‚îÄ‚îÄ
const NY_SCALE = [
  {label:'NY',  min:0,  max:54,  num:45,  color:'red',    pass:false, msg:'Not Yet ‚Äî needs significant work'},
  {label:'NY+', min:55, max:59,  num:57,  color:'red',    pass:false, msg:'Not Yet+ ‚Äî getting closer'},
  {label:'L',   min:60, max:62,  num:61,  color:'yellow', pass:false, msg:'Limited ‚Äî just below passing'},
  {label:'L+',  min:63, max:64,  num:63,  color:'yellow', pass:false, msg:'Limited+ ‚Äî almost there'},
  {label:'D',   min:65, max:67,  num:66,  color:'yellow', pass:true,  msg:'Developing ‚Äî just passing'},
  {label:'D+',  min:68, max:69,  num:68,  color:'yellow', pass:true,  msg:'Developing+ ‚Äî passing'},
  {label:'P',   min:70, max:74,  num:72,  color:'green',  pass:true,  msg:'Proficient ‚Äî solid pass'},
  {label:'P+',  min:75, max:79,  num:77,  color:'green',  pass:true,  msg:'Proficient+ ‚Äî strong'},
  {label:'M',   min:80, max:89,  num:85,  color:'green',  pass:true,  msg:'Meeting ‚Äî excellent'},
  {label:'M+',  min:90, max:100, num:95,  color:'green',  pass:true,  msg:'Meeting+ ‚Äî mastery!'},
];
function scaleFromLabel(lbl){ return NY_SCALE.find(s=>s.label===lbl)||null; }
function scaleFromNum(n){ return NY_SCALE.slice().reverse().find(s=>n>=s.min)||NY_SCALE[0]; }
function toNum(val){
  const byLbl = scaleFromLabel(String(val).trim().toUpperCase());
  if(byLbl) return byLbl.num;
  const n = parseInt(val);
  return isNaN(n)?null:Math.max(0,Math.min(100,n));
}

// ‚îÄ‚îÄ SUBJECTS + NEW VISIONS BIOLOGY UNITS ‚îÄ‚îÄ
const SUBJ={
  biology:{
    name:'Biology / Living Environment',
    units:[
      {id:'u1', name:'Unit 1: Marathon Runner',          emoji:'üèÉ',
       topics:['Cell Organization','Homeostasis','Cellular Respiration','Gas Exchange','Energy Transfer','Organ Systems','Muscle Fatigue'],
       link:'https://www.newvisions.org/curriculum/science/biology',
       khan:'https://www.khanacademy.org/science/ap-biology/cellular-energetics',
       tip:'Focus on homeostasis and cellular respiration ‚Äî these show up on every Living Environment Regents.'},
      {id:'u2', name:'Unit 2: Humans vs. Bacteria',      emoji:'ü¶†',
       topics:['Natural Selection','Evolution','Antibiotic Resistance','Microbiome','Disease Transmission','Immune Response'],
       link:'https://www.newvisions.org/curriculum/science/biology',
       khan:'https://www.khanacademy.org/science/ap-biology/natural-selection',
       tip:'Natural selection and antibiotic resistance are tested heavily. Know the Rock Pocket Mice experiment.'},
      {id:'u3', name:'Unit 3: Evolution of Sick Humans', emoji:'üß¨',
       topics:['DNA Structure','Protein Synthesis','Genetic Traits','Mutations','Common Ancestry','CER Writing'],
       link:'https://www.newvisions.org/curriculum/science/biology',
       khan:'https://www.khanacademy.org/science/ap-biology/gene-expression-and-regulation',
       tip:'DNA ‚Üí RNA ‚Üí Protein is essential. Practice CER (Claim-Evidence-Reasoning) writing for the Regents essays.'},
      {id:'u4', name:'Unit 4: Saving the Mountain Lion', emoji:'ü¶Å',
       topics:['Genetic Variation','Meiosis','Mitosis','Human Reproduction','Population Genetics','Heredity'],
       link:'https://www.newvisions.org/curriculum/science/biology',
       khan:'https://www.khanacademy.org/science/ap-biology/heredity',
       tip:'Know the difference between mitosis and meiosis. Punnett squares appear on Regents every year.'},
      {id:'u5', name:'Unit 5: Food for All',             emoji:'üå±',
       topics:['Photosynthesis','Ecosystem Carrying Capacity','Carbon Cycle','Macromolecules','Food Webs','Energy Flow'],
       link:'https://www.newvisions.org/curriculum/science/biology',
       khan:'https://www.khanacademy.org/science/ap-biology/cellular-energetics/photosynthesis',
       tip:'Photosynthesis and food webs are high-frequency Regents topics. Know the carbon cycle diagram.'},
      {id:'u6', name:'Unit 6: Woolly Mammoth',           emoji:'ü¶£',
       topics:['Biodiversity','Human Impact','Ecosystem Stability','Population Dynamics','Conservation','Extinction'],
       link:'https://www.newvisions.org/curriculum/science/biology',
       khan:'https://www.khanacademy.org/science/ap-biology/ecology',
       tip:'Human impact on ecosystems and biodiversity are common in the last section of the Regents.'},
    ]
  },
  algebra:{
    name:'Algebra 1',
    units:[
      {id:'alg1', name:'Linear Equations & Inequalities', emoji:'üìê',
       topics:['Linear Equations','Inequalities','Systems of Equations','Word Problems'],
       link:'https://www.khanacademy.org/math/algebra/x2f8bb11595b61c86:linear-equations-graphs',
       khan:'https://www.khanacademy.org/math/algebra', tip:'Systems of equations appear every year on the Regents. Practice writing equations from word problems.'},
      {id:'alg2', name:'Functions & Quadratics', emoji:'üìà',
       topics:['Functions','Quadratic Equations','Polynomials','Factoring'],
       link:'https://www.khanacademy.org/math/algebra/x2f8bb11595b61c86:quadratic-functions-equations',
       khan:'https://www.khanacademy.org/math/algebra', tip:'Know how to factor and use the quadratic formula. Function notation is tested every exam.'},
      {id:'alg3', name:'Statistics & Probability', emoji:'üìä',
       topics:['Statistics','Data Analysis','Probability','Exponential Functions'],
       link:'https://www.khanacademy.org/math/statistics-probability',
       khan:'https://www.khanacademy.org/math/algebra', tip:'Statistics questions are worth a lot of points and students often skip them. Practice scatter plots and regression.'},
    ]
  },
  ela:{
    name:'English ELA',
    units:[
      {id:'ela1', name:'Reading & Text Analysis', emoji:'üìñ',
       topics:['Reading Comprehension','Literary Analysis','Informational Text','Vocabulary in Context'],
       link:'https://www.regentsprep.org/ela/', khan:'https://www.khanacademy.org/ela',
       tip:'Read the questions BEFORE the passage ‚Äî it saves time and focuses your reading.'},
      {id:'ela2', name:'Writing & Argumentation', emoji:'‚úçÔ∏è',
       topics:['Argument Essay','Evidence & Reasoning','Narrative Writing','Research Skills'],
       link:'https://www.regentsprep.org/ela/', khan:'https://www.khanacademy.org/ela',
       tip:'Your argument essay needs a clear claim, 3 pieces of evidence, and a counterargument. Practice this structure.'},
      {id:'ela3', name:'Grammar & Editing', emoji:'üî§',
       topics:['Grammar & Usage','Revising & Editing','Sentence Structure'],
       link:'https://www.regentsprep.org/ela/', khan:'https://www.khanacademy.org/ela',
       tip:'Revising & Editing is the most coachable part of the ELA Regents. Practice eliminating redundancy.'},
    ]
  },
  us_history:{
    name:'US History',
    units:[
      {id:'ush1', name:'Foundations‚ÄìCivil War', emoji:'üèõÔ∏è',
       topics:['Colonial Era','Constitution & Founding','Civil War','Reconstruction'],
       link:'https://www.khanacademy.org/humanities/us-history', khan:'https://www.khanacademy.org/humanities/us-history',
       tip:'Know the major turning points ‚Äî Constitution, Civil War causes, and Reconstruction outcomes.'},
      {id:'ush2', name:'Industrial Era‚ÄìWWII', emoji:'üè≠',
       topics:['Progressive Era','WWI','Great Depression','WWII','New Deal'],
       link:'https://www.khanacademy.org/humanities/us-history', khan:'https://www.khanacademy.org/humanities/us-history',
       tip:'The Great Depression and New Deal appear on almost every Regents exam.'},
      {id:'ush3', name:'Cold War‚ÄìModern', emoji:'üåé',
       topics:['Cold War','Civil Rights Movement','Vietnam Era','Modern America','DBQ Skills'],
       link:'https://www.khanacademy.org/humanities/us-history', khan:'https://www.khanacademy.org/humanities/us-history',
       tip:'DBQ (Document-Based Questions) ‚Äî always tie your answer back to the document AND historical context.'},
    ]
  },
  shsat:{
    name:'SHSAT Prep',
    units:[
      {id:'sh1', name:'English Language Arts', emoji:'üìù',
       topics:['Scrambled Paragraphs','Reading Comprehension','Revising & Editing','Logical Reasoning'],
       link:'https://www.khanacademy.org/prep/shsat', khan:'https://www.khanacademy.org/prep/shsat',
       tip:'Scrambled Paragraphs are unique to SHSAT ‚Äî practice this daily. Most students underestimate it.'},
      {id:'sh2', name:'Mathematics', emoji:'üî¢',
       topics:['Algebra','Geometry','Word Problems','Number Theory','Statistics','Probability'],
       link:'https://www.khanacademy.org/prep/shsat', khan:'https://www.khanacademy.org/prep/shsat',
       tip:'SHSAT math goes beyond Regents Algebra. Focus on word problems ‚Äî they require multi-step thinking.'},
    ]
  }
};

// Assignment categories + weights (matches Jupiter/New Visions)
const CATEGORIES = {
  formative:   {label:'Formative',             weight:0.50, desc:'Classwork, labs, homework ‚Äî 50% of grade'},
  summative:   {label:'Summative',             weight:0.30, desc:'Tests, exams, CERs ‚Äî 30% of grade'},
  engagement:  {label:'Scholarship + Engagement', weight:0.20, desc:'Participation, meetings, collaboration ‚Äî 20% of grade'},
};

function toast(msg,type='info'){const t=document.getElementById('toast');t.textContent=msg;t.className='show '+type;setTimeout(()=>t.className='',3000);}
function H(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function set(html){document.getElementById('content').innerHTML=html;}
function showMsg(msg,type='err'){const e=document.getElementById('authMsg');e.textContent=msg;e.className='auth-msg '+type;e.style.display='block';}
function clearMsg(){const e=document.getElementById('authMsg');if(e)e.style.display='none';}

function authTab(t){
  clearMsg();
  document.getElementById('loginForm').style.display=t==='login'?'block':'none';
  document.getElementById('signupForm').style.display=t==='signup'?'block':'none';
  document.getElementById('tabLogin').classList.toggle('on',t==='login');
  document.getElementById('tabSignup').classList.toggle('on',t==='signup');
}
function pickRole(r){
  ROLE=r;
  document.querySelectorAll('.role-btn').forEach(b=>b.classList.remove('on'));
  document.getElementById('r-'+r).classList.add('on');
  document.getElementById('gradeRow').style.display=r==='student'?'block':'none';
}

async function doLogin(){
  const email=document.getElementById('liEmail').value.trim();
  const pass=document.getElementById('liPass').value;
  if(!email||!pass)return showMsg('Please enter your email and password.');
  const btn=document.getElementById('liBtn');
  btn.disabled=true;btn.textContent='Signing in...';
  const{data,error}=await db.auth.signInWithPassword({email,password:pass});
  btn.disabled=false;btn.textContent='Sign In ‚Üí';
  if(error)return showMsg(error.message);
  await loadAndEnter(data.user);
}

async function doSignup(){
  const name=document.getElementById('suName').value.trim();
  const email=document.getElementById('suEmail').value.trim();
  const pass=document.getElementById('suPass').value;
  const grade=document.getElementById('suGrade').value;
  if(!name||!email||!pass)return showMsg('Please fill in all fields.');
  if(pass.length<6)return showMsg('Password must be at least 6 characters.');
  if(!ROLE)return showMsg('Please select your role.');
  const btn=document.getElementById('suBtn');
  btn.disabled=true;btn.textContent='Creating account...';
  const{data,error}=await db.auth.signUp({email,password:pass});
  if(error){btn.disabled=false;btn.textContent='Create Account ‚Üí';return showMsg(error.message);}
  if(data.user){
    await db.from('profiles').insert({id:data.user.id,email,full_name:name,first_name:name.split(' ')[0],role:ROLE,grade_level:grade||null,parent_code:ROLE==='student'?Math.random().toString(36).substring(2,8).toUpperCase():null});
    const{data:ld}=await db.auth.signInWithPassword({email,password:pass});
    btn.disabled=false;btn.textContent='Create Account ‚Üí';
    if(ld?.user){
      USER=ld.user;
      let{data:p}=await db.from('profiles').select('*').eq('id',ld.user.id).single();
      PROFILE=p||{id:ld.user.id,email,full_name:name,first_name:name.split(' ')[0],role:ROLE,grade_level:grade||null};
      enterApp();
    } else{showMsg('Account created! Please sign in.','ok');authTab('login');}
  }
}

async function loadAndEnter(user){
  USER=user;
  const{data:p}=await db.from('profiles').select('*').eq('id',user.id).single();
  PROFILE=p||{id:user.id,email:user.email,full_name:'User',first_name:'User',role:'student'};
  enterApp();
}

function enterApp(){
  document.getElementById('authScreen').style.display='none';
  document.getElementById('app').style.display='block';
  document.getElementById('topName').textContent=PROFILE.first_name||'User';
  const rb=document.getElementById('topRole');
  rb.textContent=PROFILE.role||'student';
  rb.className='rbadge '+(PROFILE.role||'student');
  buildNav();
  clearMsg();
  // If coming from Quick Check, show a welcome message
  const fromQC = new URLSearchParams(window.location.search).get('from') === 'quickcheck';
  if(fromQC) toast('Welcome! Start entering grades to track your progress üéØ', 'success');
}

async function doLogout(){
  await db.auth.signOut();
  USER=null;PROFILE=null;ROLE='';
  document.getElementById('app').style.display='none';
  document.getElementById('mobNav').style.display='none';
  document.getElementById('authScreen').style.display='flex';
}

const NAVS={
  student:[
    {id:'grades',    icon:'üìù',label:'Enter Grades'},
    {id:'readiness', icon:'üìä',label:'My Readiness'},
    {id:'studyplan', icon:'üéØ',label:'Study Plan'},
    {id:'history',   icon:'üìã',label:'Grade History'},
    {id:'myclass',   icon:'üè´',label:'My Classroom'},
    {id:'tutors',    icon:'üìö',label:'Tutors & Resources'},
    {id:'resources', icon:'üóÇ', label:'NYC Resources'},
  ],
  teacher:[
    {id:'overview',  icon:'üìä',label:'Overview'},
    {id:'classrooms',icon:'üè´',label:'My Classrooms'},
    {id:'students',  icon:'üë•',label:'Student Progress'},
    {id:'resources', icon:'üóÇ', label:'NYC Resources'},
  ],
  parent:[
    {id:'children',  icon:'üë®‚Äçüë©‚Äçüëß',label:'My Children'},
    {id:'resources', icon:'üóÇ', label:'NYC Resources'},
  ]
};

function buildNav(){
  const items=NAVS[PROFILE.role]||NAVS.student;
  document.getElementById('sidebar').innerHTML=
    `<div class="nav-lbl">Menu</div>`+
    items.map(n=>`<button class="nav-item" id="n-${n.id}" onclick="showTab('${n.id}')">${n.icon} ${n.label}</button>`).join('')+
    `<hr class="nav-sep"><a href="resources.html" target="_blank" style="display:flex;align-items:center;gap:7px;font-size:12px;color:var(--teal);font-weight:600;text-decoration:none;padding:8px 11px;border-radius:8px;transition:background 0.15s" onmouseover="this.style.background='var(--teal-light)'" onmouseout="this.style.background=''">‚Üó Full Resource Hub</a>`;
  const mob=document.getElementById('mobNavInner');
  mob.innerHTML=items.slice(0,5).map(n=>`<button class="mb-btn" id="mn-${n.id}" onclick="showTab('${n.id}')"><span class="mb-ico">${n.icon}</span>${n.label.split(' ')[0]}</button>`).join('');
  document.getElementById('mobNav').style.display='block';
  showTab(items[0].id);
}

function showTab(id){
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('on'));
  document.querySelectorAll('.mb-btn').forEach(n=>n.classList.remove('on'));
  const el=document.getElementById('n-'+id);if(el)el.classList.add('on');
  const mel=document.getElementById('mn-'+id);if(mel)mel.classList.add('on');
  ({grades:pgGrades,readiness:pgReadiness,studyplan:pgStudyPlan,history:pgHistory,myclass:pgMyClass,tutors:pgTutors,overview:pgOverview,classrooms:pgClassrooms,students:pgStudents,children:pgChildren,resources:pgResources}[id]||pgGrades)();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STUDENT PAGES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

function pgGrades(){
  set(`<div class="page">
    <div class="page-title">üìù Enter Grades</div>
    <div class="page-sub">Log grades from Jupiter or enter NY‚ÜíM+ directly ‚Äî we'll build your study plan</div>

    <div class="card" style="max-width:560px">
      <div class="card-head">Add a grade</div>

      <div class="fgroup"><label class="flbl">Subject</label>
        <select class="finp" id="sSubj" onchange="fillUnits()">
          <option value="">Select subject...</option>
          <option value="biology">üß¨ Biology / Living Environment (Regents)</option>
          <option value="algebra">üìê Algebra 1 (Regents)</option>
          <option value="ela">üìñ English ELA (Regents)</option>
          <option value="us_history">üá∫üá∏ US History (Regents)</option>
          <option value="shsat">üè´ SHSAT Prep</option>
        </select>
      </div>

      <div class="fgroup"><label class="flbl">Unit</label>
        <select class="finp" id="sUnit"><option value="">Select subject first...</option></select>
      </div>

      <div class="frow">
        <div class="fgroup" style="flex:1">
          <label class="flbl">Grade</label>
          <div style="display:flex;gap:8px;align-items:center">
            <input type="text" class="finp" id="sGrade" placeholder="e.g. P+ or 78" style="flex:1" oninput="previewGrade()">
            <div id="gradePreview" style="font-size:13px;font-weight:700;color:var(--gray);white-space:nowrap;min-width:80px"></div>
          </div>
          <div style="font-size:11px;color:var(--gray);margin-top:4px">Enter NY / NY+ / L / L+ / D / D+ / P / P+ / M / M+ <em>or</em> a number 0‚Äì100</div>
        </div>
        <div class="fgroup">
          <label class="flbl">Category</label>
          <select class="finp" id="sType">
            <option value="formative">Formative (50%)</option>
            <option value="summative">Summative (30%)</option>
            <option value="engagement">Scholarship + Engagement (20%)</option>
          </select>
        </div>
      </div>

      <div class="fgroup"><label class="flbl">Assignment name (optional)</label>
        <input type="text" class="finp" id="sAssign" placeholder="e.g. Gas Exchange Quiz, Mock Regents"></div>

      <!-- NY scale quick tap -->
      <div style="margin-bottom:16px">
        <div style="font-size:11px;font-weight:700;color:var(--gray);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Quick select:</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap" id="scaleButtons">
          ${NY_SCALE.map(s=>`<button onclick="tapScale('${s.label}')" style="padding:5px 11px;border:1.5px solid var(--border);border-radius:20px;font-size:12px;font-weight:700;cursor:pointer;background:white;font-family:'Plus Jakarta Sans',sans-serif;transition:all 0.15s;color:${s.color==='red'?'#dc2626':s.color==='yellow'?'#d97706':'#059669'}" class="scale-btn" data-lbl="${s.label}">${s.label}</button>`).join('')}
        </div>
      </div>

      <button class="btn-black" id="saveBtn" onclick="saveGrade()">Save Grade ‚úì</button>
      <div class="save-ok" id="gradeOk">‚úì Saved! Check My Readiness to see your score update.</div>
    </div>

    <!-- Recent entries -->
    <div id="recentGrades" style="max-width:560px"></div>
  </div>`);
  loadRecentGrades();
}

function fillUnits(){
  const s=document.getElementById('sSubj').value;
  const sel=document.getElementById('sUnit');
  sel.innerHTML='<option value="">Select unit...</option>';
  if(!s||!SUBJ[s])return;
  const subj=SUBJ[s];
  const units=subj.units||[];
  units.forEach(u=>{
    const o=document.createElement('option');
    o.value=u.id;
    o.textContent=u.emoji+' '+u.name;
    sel.appendChild(o);
  });
}

function tapScale(lbl){
  document.getElementById('sGrade').value=lbl;
  document.querySelectorAll('.scale-btn').forEach(b=>{
    b.style.background = b.dataset.lbl===lbl ? 'var(--black)' : 'white';
    b.style.color = b.dataset.lbl===lbl ? 'white' : (NY_SCALE.find(s=>s.label===b.dataset.lbl)?.color==='red'?'#dc2626':NY_SCALE.find(s=>s.label===b.dataset.lbl)?.color==='yellow'?'#d97706':'#059669');
    b.style.borderColor = b.dataset.lbl===lbl ? 'var(--black)' : 'var(--border)';
  });
  previewGrade();
}

function previewGrade(){
  const raw=document.getElementById('sGrade')?.value;
  const prev=document.getElementById('gradePreview');
  if(!prev)return;
  if(!raw){prev.textContent='';return;}
  const num=toNum(raw);
  if(num===null){prev.textContent='‚ùì invalid';return;}
  const sc=scaleFromNum(num);
  const colors={red:'#dc2626',yellow:'#d97706',green:'#059669'};
  prev.innerHTML=`<span style="color:${colors[sc.color]}">${sc.pass?'‚úì':'‚úó'} ${sc.label} ¬∑ ${num}</span>`;
}

async function saveGrade(){
  const subj=document.getElementById('sSubj').value;
  const unit=document.getElementById('sUnit').value;
  const raw=document.getElementById('sGrade').value.trim();
  const type=document.getElementById('sType').value;
  const assign=document.getElementById('sAssign')?.value.trim()||'';
  if(!subj)return toast('Please select a subject','error');
  if(!unit)return toast('Please select a unit','error');
  if(!raw)return toast('Please enter a grade','error');
  const num=toNum(raw);
  if(num===null)return toast('Enter a valid grade (e.g. P+ or 78)','error');
  const sc=scaleFromNum(num);
  const btn=document.getElementById('saveBtn');btn.disabled=true;btn.textContent='Saving...';
  const{error}=await db.from('grade_entries').insert({
    student_id:USER.id, subject:subj, topic:unit,
    grade:num, assignment_type:type,
    exam_type:subj==='shsat'?'SHSAT':'Regents',
    notes:assign||sc.label  // store label in notes
  });
  btn.disabled=false;btn.textContent='Save Grade ‚úì';
  if(error)return toast('Error: '+error.message,'error');
  document.getElementById('sGrade').value='';
  document.getElementById('sAssign').value='';
  document.querySelectorAll('.scale-btn').forEach(b=>{b.style.background='white';b.style.borderColor='var(--border)';});
  document.getElementById('gradePreview').textContent='';
  const ok=document.getElementById('gradeOk');ok.style.display='block';setTimeout(()=>ok.style.display='none',4000);
  await calcReadiness(subj);
  loadRecentGrades();
  toast('Grade saved! ‚úì','success');
}

async function loadRecentGrades(){
  const el=document.getElementById('recentGrades');if(!el)return;
  const{data}=await db.from('grade_entries').select('*').eq('student_id',USER.id).order('created_at',{ascending:false}).limit(8);
  if(!data?.length){el.innerHTML='';return;}
  el.innerHTML=`<div class="card"><div class="card-head">üìã Recent entries</div>
    <table style="width:100%;font-size:13px;border-collapse:collapse">
      <tr style="font-size:11px;font-weight:700;color:var(--gray);text-transform:uppercase;letter-spacing:1px">
        <th style="text-align:left;padding:4px 0">Subject</th>
        <th style="text-align:left;padding:4px 0">Unit</th>
        <th style="text-align:center;padding:4px 8px">Grade</th>
        <th style="text-align:left;padding:4px 0">Category</th>
      </tr>
      ${data.map(g=>{
        const sc=scaleFromNum(g.grade);
        const colors={red:'#dc2626',yellow:'#d97706',green:'#059669'};
        const subjName=SUBJ[g.subject]?.name||g.subject;
        const unitName=(SUBJ[g.subject]?.units||[]).find(u=>u.id===g.topic)?.name||g.topic;
        const catName=CATEGORIES[g.assignment_type]?.label||g.assignment_type;
        return`<tr style="border-top:1px solid var(--border)">
          <td style="padding:8px 0;font-weight:600">${subjName.split('/')[0].trim()}</td>
          <td style="padding:8px 0;color:var(--gray);font-size:12px">${unitName.replace(/Unit \d+: /,'')}</td>
          <td style="padding:8px;text-align:center;font-weight:800;color:${colors[sc.color]}">${g.notes||sc.label}</td>
          <td style="padding:8px 0;font-size:11px;color:var(--gray)">${catName}</td>
        </tr>`;
      }).join('')}
    </table>
  </div>`;
}

async function calcReadiness(subj){
  const{data}=await db.from('grade_entries').select('grade,assignment_type,topic').eq('student_id',USER.id).eq('subject',subj);
  if(!data?.length)return;
  // Weighted average by category
  const byType={formative:[],summative:[],engagement:[]};
  data.forEach(g=>{ if(byType[g.assignment_type]) byType[g.assignment_type].push(g.grade); });
  let weighted=0, totalWeight=0;
  Object.entries(CATEGORIES).forEach(([k,cat])=>{
    const arr=byType[k];
    if(arr.length){
      const avg=arr.reduce((s,v)=>s+v,0)/arr.length;
      weighted+=avg*cat.weight;
      totalWeight+=cat.weight;
    }
  });
  const avg=totalWeight>0?Math.round(weighted/totalWeight):Math.round(data.reduce((s,g)=>s+g.grade,0)/data.length);
  const color=avg>=75?'green':avg>=65?'yellow':'red';
  await db.from('readiness_scores').upsert({student_id:USER.id,subject:subj,readiness_percentage:avg,predicted_score:avg,color_status:color,last_updated:new Date().toISOString()},{onConflict:'student_id,subject'});
}

async function pgReadiness(){
  set(`<div class="page"><div class="page-title">üìä My Readiness Score</div><div class="page-sub">Weighted by Formative (50%) ¬∑ Summative (30%) ¬∑ Scholarship+Engagement (20%)</div><div id="rCont"><div class="empty-box"><p>Loading...</p></div></div></div>`);
  const{data:scores}=await db.from('readiness_scores').select('*').eq('student_id',USER.id);
  const el=document.getElementById('rCont');if(!el)return;
  if(!scores?.length){
    el.innerHTML=`<div class="card"><div class="empty-box"><h3>No scores yet</h3><p>Go to <strong>Enter Grades</strong> and log a few grades first!</p></div></div>`;return;
  }
  const colors={red:'#dc2626',yellow:'#d97706',green:'#059669'};
  el.innerHTML=`<div class="g3">${scores.map(s=>{
    const sc=scaleFromNum(s.readiness_percentage);
    const lbl=sc.pass?`üü¢ ${sc.label} ‚Äî ${sc.msg}`:`üî¥ ${sc.label} ‚Äî ${sc.msg}`;
    const pct=s.readiness_percentage;
    const passGap=pct<65?`Need ${65-pct} more points to reach D (passing)`:'';
    return`<div class="card" style="text-align:center">
      <div style="font-size:13px;font-weight:700;margin-bottom:6px">${SUBJ[s.subject]?.name?.split('/')[0]||s.subject}</div>
      <div class="r-circle ${s.color_status}">${pct}%</div>
      <div class="r-label ${s.color_status}" style="margin:8px 0 4px">${sc.label}</div>
      <div style="font-size:12px;color:var(--gray);margin-bottom:6px">${sc.msg}</div>
      ${passGap?`<div style="font-size:11px;font-weight:700;color:#dc2626;background:#fff1f2;border-radius:8px;padding:5px 10px">${passGap}</div>`:''}
    </div>`;
  }).join('')}</div>
  <div class="card"><div class="card-head">üìñ How the score is calculated</div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:4px">
      ${Object.entries(CATEGORIES).map(([k,c])=>`<div style="background:var(--bg);border-radius:10px;padding:12px;text-align:center">
        <div style="font-size:20px;font-weight:900;color:var(--teal)">${Math.round(c.weight*100)}%</div>
        <div style="font-size:12px;font-weight:700">${c.label}</div>
        <div style="font-size:11px;color:var(--gray);margin-top:3px">${c.desc}</div>
      </div>`).join('')}
    </div>
    <div style="font-size:12px;color:var(--gray);margin-top:14px;line-height:1.7">
      <b>Passing the Regents = 65 (D on the scale).</b> Aim for P+ (75+) to have a safety margin.<br>
      NY scale: NY‚ÜíNY+‚ÜíL‚ÜíL+‚ÜíD‚ÜíD+‚ÜíP‚ÜíP+‚ÜíM‚ÜíM+ matches your Jupiter gradebook exactly.
    </div>
  </div>`;
}

async function pgStudyPlan(){
  set(`<div class="page"><div class="page-title">üéØ My Study Plan</div><div class="page-sub">Unit-level focus areas based on your grades</div><div id="spCont"><div class="empty-box"><p>Loading...</p></div></div></div>`);
  const{data:grades}=await db.from('grade_entries').select('*').eq('student_id',USER.id);
  const el=document.getElementById('spCont');if(!el)return;
  if(!grades?.length){
    el.innerHTML=`<div class="section"><div class="empty-box"><h3>No grades yet</h3><p>Enter some grades first ‚Äî your personalized unit study plan will appear here.</p></div></div>`;return;
  }
  // Group by subject ‚Üí unit
  const bySubj={};
  grades.forEach(g=>{
    if(!bySubj[g.subject])bySubj[g.subject]={};
    if(!bySubj[g.subject][g.topic])bySubj[g.subject][g.topic]=[];
    bySubj[g.subject][g.topic].push(g);
  });
  let html='';
  Object.entries(bySubj).forEach(([subjId,byUnit])=>{
    const subj=SUBJ[subjId];if(!subj)return;
    html+=`<div class="section"><div class="sec-head">${subj.name}</div>`;
    // Compute avg per unit, sort worst first
    const unitScores=Object.entries(byUnit).map(([unitId,gs])=>{
      const avg=gs.reduce((s,g)=>s+g.grade,0)/gs.length;
      const unit=(subj.units||[]).find(u=>u.id===unitId)||{id:unitId,name:unitId,emoji:'üìö',link:'#',khan:'#',tip:''};
      return{unitId,unit,avg:Math.round(avg),count:gs.length};
    }).sort((a,b)=>a.avg-b.avg);

    unitScores.forEach(({unit,avg,count})=>{
      const sc=scaleFromNum(avg);
      const colors={red:'#dc2626',yellow:'#d97706',green:'#059669'};
      const bg={red:'#fff1f2',yellow:'#fffbeb',green:'#f0fdf4'};
      const priority=sc.color==='red'?'üî¥ Focus here first':sc.color==='yellow'?'üü° Needs practice':'üü¢ On track';
      const action=sc.color==='red'
        ?`Start with the New Visions lesson for this unit tonight.`
        :sc.color==='yellow'
        ?`Review key concepts and do 1 past Regents question on this unit.`
        :`Keep it up ‚Äî do a quick review before the exam.`;
      html+=`<div style="background:${bg[sc.color]};border-radius:14px;padding:18px;margin-bottom:12px;border-left:4px solid ${colors[sc.color]}">
        <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:8px">
          <div>
            <div style="font-size:15px;font-weight:800">${unit.emoji||'üìö'} ${unit.name}</div>
            <div style="font-size:12px;color:var(--gray);margin-top:2px">${count} grade${count>1?'s':''} entered ¬∑ Avg: <strong style="color:${colors[sc.color]}">${sc.label} (${avg}%)</strong></div>
          </div>
          <div style="font-size:20px;font-weight:900;color:${colors[sc.color]};flex-shrink:0">${avg}%</div>
        </div>
        <div style="font-size:13px;font-weight:700;color:${colors[sc.color]};margin-bottom:6px">${priority}</div>
        <div style="font-size:13px;color:#374151;margin-bottom:10px">${action}${unit.tip?` <em style="color:var(--gray)">${unit.tip}</em>`:''}</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <a href="${unit.link}" target="_blank" style="font-size:12px;font-weight:700;color:white;background:var(--black);padding:7px 14px;border-radius:8px;text-decoration:none">üìñ New Visions lesson ‚Üí</a>
          <a href="${unit.khan}" target="_blank" style="font-size:12px;font-weight:700;color:var(--black);background:white;border:1.5px solid var(--border);padding:7px 14px;border-radius:8px;text-decoration:none">üü¢ Khan Academy ‚Üí</a>
        </div>
      </div>`;
    });
    html+='</div>';
  });
  el.innerHTML=html;
}


async function pgHistory(){
  set(`<div class="page"><div class="page-title">üìã Grade History</div><div class="page-sub">All your entered grades</div><div id="hCont"><div class="empty-box"><p>Loading...</p></div></div></div>`);
  const{data:grades}=await db.from('grade_entries').select('*').eq('student_id',USER.id).order('entry_date',{ascending:false});
  const el=document.getElementById('hCont');if(!el)return;
  if(!grades?.length){el.innerHTML=`<div class="section"><div class="empty-box"><h3>No grades yet</h3><p>Go to <strong>Enter Grades</strong> to get started!</p></div></div>`;return;}
  el.innerHTML=`<div class="section"><div class="sec-head">All Grades <span style="font-size:13px;font-weight:400;color:var(--gray)">${grades.length} entries</span></div>
    <table><thead><tr><th>Subject</th><th>Topic</th><th>Type</th><th>Grade</th><th>Date</th></tr></thead>
    <tbody>${grades.map(g=>{const c=g.grade>=75?'g':g.grade>=55?'y':'r';const d=g.entry_date?new Date(g.entry_date).toLocaleDateString():'‚Äî';return`<tr><td>${SUBJ[g.subject]?.name||g.subject}</td><td>${H(g.topic)}</td><td style="text-transform:capitalize">${g.assignment_type||'‚Äî'}</td><td><span class="badge ${c}">${g.grade}%</span></td><td>${d}</td></tr>`;}).join('')}</tbody>
    </table></div>`;
}

async function pgMyClass(){
  set(`<div class="page"><div class="page-title">üè´ My Classroom</div><div class="page-sub">Join your teacher's class to share your readiness progress</div>
    <div class="section"><div class="sec-head">Join a Class</div>
      <div class="irow"><input class="finp" id="jCode" placeholder="Class code e.g. MATH101" style="max-width:220px;text-transform:uppercase"><button class="btn-black" onclick="joinClass()">Join ‚Üí</button></div>
      <p style="font-size:12px;color:var(--gray)">Ask your teacher for the class code.</p>
    </div>
    <div class="section"><div class="sec-head">My Classes</div><div id="myCList"><div class="empty-box"><p>Loading...</p></div></div></div>
  </div>`);
  const{data:cls}=await db.from('classroom_students').select('*, classrooms(*)').eq('student_id',USER.id);
  const el=document.getElementById('myCList');if(!el)return;
  if(!cls?.length){el.innerHTML=`<div class="empty-box"><h3>No classes yet</h3><p>Enter a class code above.</p></div>`;return;}
  el.innerHTML=cls.map(c=>`<div class="class-card"><div><div class="class-name">${H(c.classrooms?.class_name||'Class')}</div><div class="class-meta">${c.classrooms?.subject||''}</div></div><span class="code-pill">${c.classrooms?.class_code||''}</span></div>`).join('');
}

async function joinClass(){
  const code=(document.getElementById('jCode').value||'').trim().toUpperCase();
  if(!code)return toast('Enter a class code','error');
  const{data:room}=await db.from('classrooms').select('*').eq('class_code',code).single();
  if(!room)return toast('Class code not found','error');
  const{error}=await db.from('classroom_students').insert({classroom_id:room.id,student_id:USER.id});
  if(error)return toast('Already in this class','info');
  toast('Joined '+room.class_name+'! ‚úì','success');pgMyClass();
}

function pgTutors(){
  set(`<div class="page">
    <div class="page-title">üìö Tutors & Study Resources</div>
    <div class="page-sub">Free tools and tutoring for every Regents subject ‚Äî no login needed</div>

    <div class="section">
      <div class="sec-head">üÜì Free Study Tools</div>
      <div class="tgrid">
        <a href="https://www.khanacademy.org" target="_blank" class="titem"><div class="titem-ico" style="background:#f0fdf4">üü¢</div><div><div class="titem-name">Khan Academy</div><div class="titem-desc">Videos + practice for every subject</div></div><span class="ftag free">Free</span></a>
        <a href="https://www.regentsprep.org" target="_blank" class="titem"><div class="titem-ico" style="background:#eff6ff">üìù</div><div><div class="titem-name">Regents Prep</div><div class="titem-desc">NY-specific practice and review</div></div><span class="ftag free">Free</span></a>
        <a href="https://www.nysedregents.org" target="_blank" class="titem"><div class="titem-ico" style="background:#fdf4ff">üìã</div><div><div class="titem-name">NYSED Past Exams</div><div class="titem-desc">Download real past Regents exams</div></div><span class="ftag free">Free</span></a>
        <a href="https://www.newvisions.org/curriculum/science/biology" target="_blank" class="titem"><div class="titem-ico" style="background:#f0fdf4">üß¨</div><div><div class="titem-name">New Visions Biology</div><div class="titem-desc">Full Living Environment curriculum</div></div><span class="ftag free">Free</span></a>
        <a href="https://albert.io" target="_blank" class="titem"><div class="titem-ico" style="background:#fff7ed">üéØ</div><div><div class="titem-name">Albert.io</div><div class="titem-desc">Adaptive Regents practice questions</div></div><span class="ftag free">Free tier</span></a>
        <a href="https://quizlet.com" target="_blank" class="titem"><div class="titem-ico" style="background:#eff6ff">üÉè</div><div><div class="titem-name">Quizlet</div><div class="titem-desc">Flashcards for vocab and definitions</div></div><span class="ftag free">Free</span></a>
      </div>
    </div>

    <div class="section">
      <div class="sec-head">üè´ Free In-Person Tutoring in NYC</div>
      <div class="tgrid">
        <a href="https://www.nypl.org/node/69211" target="_blank" class="titem"><div class="titem-ico" style="background:#fef3c7">üìö</div><div><div class="titem-name">NYC Public Library</div><div class="titem-desc">Free tutoring at branch locations</div></div><span class="ftag free">Free</span></a>
        <a href="https://www.bklynlibrary.org/literacy" target="_blank" class="titem"><div class="titem-ico" style="background:#fef3c7">üèõÔ∏è</div><div><div class="titem-name">Brooklyn Public Library</div><div class="titem-desc">Free homework help programs</div></div><span class="ftag free">Free</span></a>
        <a href="https://www.schools.nyc.gov/learning/student-support/academic-support/after-school-programs" target="_blank" class="titem"><div class="titem-ico" style="background:#f0fdf4">üè´</div><div><div class="titem-name">NYC After-School Programs</div><div class="titem-desc">Free academic support via NYC DOE</div></div><span class="ftag free">Free</span></a>
        <a href="https://www.wyzant.com" target="_blank" class="titem"><div class="titem-ico" style="background:#f0f9ff">üë®‚Äçüè´</div><div><div class="titem-name">Wyzant</div><div class="titem-desc">Find verified private tutors near you</div></div><span class="ftag paid">Paid</span></a>
      </div>
    </div>

    <a href="resources.html" target="_blank" style="display:flex;align-items:center;justify-content:space-between;background:#0f1f3d;border-radius:16px;padding:24px 28px;color:white;text-decoration:none;transition:all 0.2s;gap:16px" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
      <div><div style="font-size:17px;font-weight:800;margin-bottom:5px">üóÇ Full NYC Student Resource Hub</div><div style="font-size:13px;color:#94a3b8">Internships, scholarships, CTE, college prep ‚Äî 18+ programs</div></div>
      <span style="background:var(--teal);color:white;padding:10px 18px;border-radius:9px;font-weight:700;font-size:14px;white-space:nowrap">Explore ‚Üí</span>
    </a>
  </div>`);
}

function pgResources(){
  set(`<div class="page">
    <div class="page-title">üóÇ NYC Student Resources</div>
    <div class="page-sub">Key opportunities for NYC public high school students</div>
    <a href="resources.html" target="_blank" style="display:flex;align-items:center;justify-content:space-between;background:#0f1f3d;border-radius:16px;padding:24px 28px;color:white;text-decoration:none;margin-bottom:20px;transition:all 0.2s;gap:16px" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
      <div><div style="font-size:18px;font-weight:800;margin-bottom:5px">Open Full Resource Hub ‚Üí</div><div style="font-size:13px;color:#94a3b8">18+ programs ¬∑ searchable ¬∑ filterable</div></div>
      <span style="font-size:32px">üöÄ</span>
    </a>
    <div class="g2">
      <div class="card"><div class="card-head">üíº Summer Jobs & Internships</div><div style="font-size:13px;line-height:2.3">
        <a href="https://www.nyc.gov/site/dycd/services/jobs-internships/summer-youth-employment-program-syep.page" target="_blank" style="color:var(--teal);font-weight:600;display:block">üíº SYEP ‚Äî Paid jobs, ages 14-24</a>
        <a href="https://snow.day" target="_blank" style="color:var(--teal);font-weight:600;display:block">‚ùÑÔ∏è Snow.day ‚Äî 500+ free programs</a>
        <a href="https://hkmakerlab.columbia.edu" target="_blank" style="color:var(--teal);font-weight:600;display:block">üîß Hk Maker Lab ‚Äî Columbia (free)</a>
        <a href="https://www.nyas.org/programs/global-stem-alliance/junior-academy/" target="_blank" style="color:var(--teal);font-weight:600;display:block">üî¨ NYAS Junior Academy ‚Äî STEM</a>
      </div></div>
      <div class="card"><div class="card-head">üéì College & Scholarships</div><div style="font-size:13px;line-height:2.3">
        <a href="https://www.hesc.ny.gov" target="_blank" style="color:var(--teal);font-weight:600;display:block">üéì CUNY Excelsior ‚Äî Free under $125K</a>
        <a href="https://studentaid.gov" target="_blank" style="color:var(--teal);font-weight:600;display:block">üìã FAFSA ‚Äî Opens December 1</a>
        <a href="https://www.fastweb.com" target="_blank" style="color:var(--teal);font-weight:600;display:block">üèÜ Fastweb ‚Äî 1.5M+ scholarships</a>
        <a href="https://www.schools.nyc.gov/enrollment/high-school/college-access-centers" target="_blank" style="color:var(--teal);font-weight:600;display:block">üè´ NYC College Access Centers</a>
      </div></div>
    </div>
    <div class="card" style="background:#fffbeb;border-color:#fde68a">
      <div class="card-head">üéì NYC Graduation Is Changing</div>
      <div style="font-size:13px;color:#374151;line-height:1.9"><strong>2027‚Äì28:</strong> New project-based pathways offered &nbsp;¬∑&nbsp; <strong>2029‚Äì30:</strong> Regents become optional<br>Internships and CTE you do NOW will count toward the new graduation requirements!</div>
    </div>
  </div>`);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TEACHER PAGES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

async function pgOverview(){
  set(`<div class="page"><div class="page-title">üìä Teacher Overview</div><div class="page-sub">Your classrooms at a glance</div><div id="ovCont"><div class="empty-box"><p>Loading...</p></div></div></div>`);
  const{data:rooms}=await db.from('classrooms').select('*, classroom_students(student_id)').eq('teacher_id',USER.id);
  const el=document.getElementById('ovCont');if(!el)return;
  if(!rooms?.length){el.innerHTML=`<div class="card"><div class="empty-box"><h3>No classrooms yet</h3><p>Go to <strong>My Classrooms</strong> to create your first class.</p></div></div>`;return;}
  el.innerHTML=`<div class="g3">${rooms.map(r=>`<div class="card" style="text-align:center"><div class="r-circle empty">üè´</div><div style="font-size:15px;font-weight:700;margin-bottom:4px">${H(r.class_name)}</div><div style="font-size:13px;color:var(--gray);margin-bottom:8px">${r.subject||''}</div><div style="font-size:24px;font-weight:800">${r.classroom_students?.length||0}</div><div style="font-size:12px;color:var(--gray)">students</div><div style="margin-top:10px"><span class="code-pill">${r.class_code}</span></div></div>`).join('')}</div>`;
}

async function pgClassrooms(){
  set(`<div class="page"><div class="page-title">üè´ My Classrooms</div><div class="page-sub">Create classes and share the code with your students</div>
    <div class="section"><div class="sec-head">Create New Class</div>
      <div class="irow">
        <input class="finp" id="cName" placeholder="Class name e.g. Period 3 Algebra" style="max-width:260px">
        <select class="finp" id="cSubj" style="max-width:200px">
          <option value="">Select subject...</option>
          <option value="algebra">Algebra 1</option><option value="ela">English ELA</option>
          <option value="biology">Biology / Living Environment</option><option value="us_history">US History</option><option value="shsat">SHSAT Prep</option>
        </select>
        <button class="btn-teal" onclick="createRoom()">+ Create Class</button>
      </div>
    </div>
    <div id="roomList"><div class="empty-box"><p>Loading...</p></div></div>
  </div>`);
  loadRooms();
}

async function loadRooms(){
  const{data:rooms}=await db.from('classrooms').select('*, classroom_students(student_id)').eq('teacher_id',USER.id);
  const el=document.getElementById('roomList');if(!el)return;
  if(!rooms?.length){el.innerHTML=`<div class="section"><div class="empty-box"><h3>No classes yet</h3><p>Create a class above and share the code with students.</p></div></div>`;return;}
  el.innerHTML=`<div class="section"><div class="sec-head">Your Classes</div>${rooms.map(r=>`<div class="class-card"><div><div class="class-name">${H(r.class_name)}</div><div class="class-meta">${r.subject||''} ¬∑ ${r.classroom_students?.length||0} students</div></div><span class="code-pill">${r.class_code}</span></div>`).join('')}</div>`;
}

async function createRoom(){
  const name=(document.getElementById('cName').value||'').trim();
  const subj=document.getElementById('cSubj').value;
  if(!name)return toast('Enter a class name','error');
  const code=name.replace(/\s+/g,'').substring(0,6).toUpperCase()+Math.floor(Math.random()*100);
  const{error}=await db.from('classrooms').insert({teacher_id:USER.id,class_name:name,subject:subj,class_code:code});
  if(error)return toast('Error: '+error.message,'error');
  document.getElementById('cName').value='';
  toast('Class created! Code: '+code,'success');
  loadRooms();
}

async function pgStudents(){
  set(`<div class="page"><div class="page-title">üë• Student Progress</div><div class="page-sub">Readiness scores across all your classrooms</div><div id="stCont"><div class="empty-box"><p>Loading...</p></div></div></div>`);
  const{data:rooms}=await db.from('classrooms').select('id,class_name').eq('teacher_id',USER.id);
  const el=document.getElementById('stCont');if(!el)return;
  if(!rooms?.length){el.innerHTML=`<div class="card"><div class="empty-box"><h3>No classrooms yet</h3><p>Create a classroom first.</p></div></div>`;return;}
  const{data:cs}=await db.from('classroom_students').select('student_id,classroom_id,profiles(full_name,grade_level),readiness_scores(subject,readiness_percentage,color_status)').in('classroom_id',rooms.map(r=>r.id));
  if(!cs?.length){el.innerHTML=`<div class="card"><div class="empty-box"><h3>No students enrolled</h3><p>Students join by entering your class code in their dashboard.</p></div></div>`;return;}
  const rows=cs.map(c=>{
    const p=c.profiles,scores=c.readiness_scores||[];
    const room=rooms.find(r=>r.id===c.classroom_id);
    const avg=scores.length?Math.round(scores.reduce((s,r)=>s+r.readiness_percentage,0)/scores.length):null;
    const worst=scores.sort((a,b)=>a.readiness_percentage-b.readiness_percentage)[0];
    const st=worst?.color_status||'none';
    const stLbl=st==='red'?'üî¥ At Risk':st==='yellow'?'üü° Needs Work':st==='green'?'üü¢ On Track':'‚¨ú No data';
    return`<tr><td><b>${H(p?.full_name||'Unknown')}</b></td><td>${H(room?.class_name||'')}</td><td>${avg!==null?avg+'%':'‚Äî'}</td><td>${stLbl}</td><td>${worst?H(worst.subject):'‚Äî'}</td></tr>`;
  }).join('');
  el.innerHTML=`<div class="section"><table><thead><tr><th>Student</th><th>Class</th><th>Avg</th><th>Status</th><th>Focus Subject</th></tr></thead><tbody>${rows}</tbody></table></div>`;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PARENT PAGES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

async function pgChildren(){
  set(`<div class="page"><div class="page-title">üë®‚Äçüë©‚Äçüëß My Children</div><div class="page-sub">Link your child's account to monitor their readiness</div>
    <div class="section"><div class="sec-head">Link a Child</div>
      <div class="irow"><input class="finp" id="cEmail" type="email" placeholder="Child's email address" style="max-width:280px"><button class="btn-black" onclick="linkChild()">Link Account ‚Üí</button></div>
      <p style="font-size:12px;color:var(--gray)">Enter your child's ZenEd email to connect accounts.</p>
    </div>
    <div id="childList"><div class="empty-box"><p>Loading...</p></div></div>
  </div>`);
  const{data:links}=await db.from('parent_child_links').select('*, profiles!parent_child_links_student_id_fkey(full_name,grade_level)').eq('parent_id',USER.id);
  const el=document.getElementById('childList');if(!el)return;
  if(!links?.length){el.innerHTML=`<div class="section"><div class="empty-box"><h3>No children linked</h3><p>Enter your child's email above.</p></div></div>`;return;}
  el.innerHTML=`<div class="section"><div class="sec-head">Linked Children</div>${links.map(l=>`<div class="class-card"><div><div class="class-name">${H(l.profiles?.full_name||'Child')}</div><div class="class-meta">Grade ${l.profiles?.grade_level||'‚Äî'}</div></div></div>`).join('')}</div>`;
}

async function linkChild(){
  const email=(document.getElementById('cEmail').value||'').trim();
  if(!email)return toast('Enter your child\'s email','error');
  const{data:child,error}=await db.from('profiles').select('*').eq('email',email).eq('role','student').single();
  if(error||!child)return toast('Student not found with that email','error');
  const{error:e2}=await db.from('parent_child_links').insert({parent_id:USER.id,student_id:child.id});
  if(e2)return toast('Already linked','info');
  toast('Linked to '+child.full_name+'! ‚úì','success');pgChildren();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
window.onload=async()=>{
  const{data:{session}}=await db.auth.getSession();
  document.getElementById('loader').classList.add('hide');
  if(session?.user){await loadAndEnter(session.user);}
  else{document.getElementById('authScreen').style.display='flex';}
  db.auth.onAuthStateChange(event=>{
    if(event==='SIGNED_OUT'){
      document.getElementById('app').style.display='none';
      document.getElementById('mobNav').style.display='none';
      document.getElementById('authScreen').style.display='flex';
    }
  });
};
</script>
</body>
</html>
